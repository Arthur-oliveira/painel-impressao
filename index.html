<script>
    // --- CONFIGURAÇÃO DE CONEXÃO ---
    // Enquanto testamos localmente, usamos localhost. 
    // Depois, trocaremos apenas este IP pelo do Radmin VPN.
    const IP_SERVIDOR = 'localhost'; 
    const URL_PROXY = `http://${IP_SERVIDOR}:8080/print`;

    async function enviarParaAPI(nomeImpressora) {
        const statusDiv = document.getElementById('status');
        statusDiv.innerText = `Comunicando com ${nomeImpressora}...`;
        statusDiv.style.color = "#888";

        // Objeto de dados formatado para o seu backend Delphi
        const dados = {
            "impressora": {
                "caminho": nomeImpressora, // Ex: 'EPSON' ou 'ELGIN'
                "model": 1
            },
            "pedido": {
                "cliente": "CLIENTE TESTE WEB",
                "pedido": Math.floor(Math.random() * 10000) // Número aleatório para teste
            },
            "produtos": [
                {
                    "descricao": "TESTE DE IMPRESSAO VIA BROWSER",
                    "quantidade": 1,
                    "observacao": ["TESTE DE CONEXAO", "REVISADO"]
                }
            ]
        };

        try {
            // timeout de 5 segundos para não travar a página se o servidor estiver offline
            const controller = new AbortController();
            const id = setTimeout(() => controller.abort(), 5000);

            const response = await fetch(URL_PROXY, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(dados),
                signal: controller.signal
            });

            clearTimeout(id);

            if (response.ok) {
                statusDiv.innerText = `✅ SUCESSO: ${nomeImpressora} respondeu!`;
                statusDiv.style.color = "#00ff88";
            } else {
                statusDiv.innerText = `❌ ERRO: Servidor retornou ${response.status}`;
                statusDiv.style.color = "#ff4444";
            }
        } catch (error) {
            if (error.name === 'AbortError') {
                statusDiv.innerText = "❌ ERRO: Tempo esgotado (Servidor Offline?)";
            } else {
                statusDiv.innerText = "❌ ERRO: Sem conexão com o Proxy.js";
            }
            statusDiv.style.color = "#ff4444";
            console.error("Falha na requisição:", error);
        }
    }

    async function imprimirNasDuas() {
        statusDiv.innerText = "Iniciando fila dupla...";
        await enviarParaAPI('EPSON');
        // Pequeno delay entre as impressões para não sobrecarregar o buffer
        setTimeout(() => {
            enviarParaAPI('ELGIN');
        }, 1000); 
    }
</script>